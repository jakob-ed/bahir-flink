# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
  
version: "3.9"
services:
  flink-benchmark:
    build:
      # Set context to flink-connector-pinot folder
      context: ../../../../../../../../../../../
      dockerfile: "flink-connector-pinot/src/main/java/org/apache/flink/streaming/connectors/pinot/benchmark/Dockerfile"
    command: [
        "FlinkApp",
        "--port", "5001",
        "--parallelism", "1",
        "--segmentSize", "100",
        "--delay", "60000" # Wait 20s before trying to connect to pinot-cluster
    ]
    depends_on:
      - data-generator
      - pinot-cluster
    networks:
      - network

  data-generator:
    build:
      # Set context to flink-connector-pinot folder
      context: ../../../../../../../../../../../
      dockerfile: "flink-connector-pinot/src/main/java/org/apache/flink/streaming/connectors/pinot/benchmark/Dockerfile"
    command: [
        "DataGenerator",
        "--numTuples", "10000",
        "--sleepTime", "100", # in milliseconds
        "--bufferSize", "1000",
        "--port", "5001"
    ]
    ports:
      - "5001:5001"
    networks:
      - network

  pinot-cluster:
    image: apachepinot/pinot:0.6.0
    command: ["QuickStart", "-type", "batch"]
    ports:
      - "9000:9000"
      - "8000:8000"
    networks:
      - network

networks:
  network: {}